<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>HackTheBox: Jeeves Walkthrough and Lessons</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="styles.css" type="text/css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-120451103-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-120451103-1');
</script>


</head>
<body><div class="main"><div class="tree">
<p><strong>Index</strong></p>
<p><a href="About.html">About</a></p>

<p><a href="Walkthroughs.html">Walkthroughs</a></p>

<ol>
<li><a href="Walkthroughs--HackTheBox_Jeeves_Walkthrough_and_Lessons.html">HackTheBox: Jeeves Walkthrough and Lessons</a></li>
<li><a href="Walkthroughs--HackTheBox_Bashed_Walkthrough_and_Lessons.html">HackTheBox: Bashed Walkthrough and Lessons</a></li>
<li><a href="Walkthroughs--HackTheBox_Chatterbox_Walkthrough_and_Lessons.html">HackTheBox: Chatterbox Walkthrough and Lessons</a></li>
</ol>
<p><a href="Courses.html">Courses</a></p>

<ol>
<li><a href="Courses--SLAE.html">SLAE</a></li>
<ol>
<li><a href="Courses--SLAE--1_TCP_Bind_Shellcode.html">1: TCP Bind Shellcode</a></li>
<li><a href="Courses--SLAE--2_TCP_Reverse_Shell.html">2: TCP Reverse Shell</a></li>
<li><a href="Courses--SLAE--3_Egghunter_Shellcode.html">3: Egghunter Shellcode</a></li>
<li><a href="Courses--SLAE--4_Shellcode_Encoding_Scheme.html">4: Shellcode Encoding Scheme</a></li>
<li><a href="Courses--SLAE--5.1_Metasploit_TCP_Bind_Shellcode_Analysis.html">5.1: Metasploit TCP Bind Shellcode Analysis</a></li>
<li><a href="Courses--SLAE--5.2_Metasploit_chmod_Shellcode_Analysis.html">5.2: Metasploit chmod Shellcode Analysis</a></li>
<li><a href="Courses--SLAE--5.3_Metasploit_exec_Shellcode_Analysis.html">5.3: Metasploit exec Shellcode Analysis</a></li>
<li><a href="Courses--SLAE--6_Polymorphic_Shellcode.html">6: Polymorphic Shellcode</a></li>
<li><a href="Courses--SLAE--7_Shellcode_Crypter.html">7: Shellcode Crypter</a></li>
</ol></ol></div>
<div class="page"><h1><b><u>HackTheBox: Jeeves Walkthrough and Lessons</u></b></h1>HackTheBox is an online community where hackers and information security enthusiasts test their offensive skills by attacking vulnerable computer systems (<strong>boxes</strong>) configured by their peers. Each box is a capture-the-flag-style challenge in which the attacker must retrieve two flags hidden in text documents within the system. One flag represents an initial breach of the system (a “user” flag) and one flag indicates that the attacker has effectively taken complete control of the system by gaining administrative/root privileges (a “root” flag).<br /><br />In the paragraphs that follow, I'll illustrate how to compromise one such system named <strong>Jeeves</strong>. I will then present some lessons learned regarding how this challenge might relate to the real world and how this knowledge might be applied to future engagements. Finally, I'll list a few supplemental resources that elaborate on some of the concepts used in the walkthrough. If you're still hungry for information by the end of this post, that might be a good place to start.<br /><br />This post (and the box itself) are largely intended for beginner-to-intermediate students of information security. If you're already an accomplished hacker, penetration tester or CTF player, you might still find it an interesting read, but odds are that this machine does not pose much of a challenge for you and the elements of penetration testing that I describe will be review. Anyone still with me, read on.<br /><br /><br /><h1>Knowing Nothing</h1><br />Since the host IP address was known, I did not perform a host discovery step. Instead I opted to scan the box speedily with <strong>nmap</strong> and begin enumerating its services.<br /><br /><img src="images\3-1.png" alt="images\3-1.png" /><br /><br />Some quick observations: it appears that Microsoft SMB services are running on the box. A website is being hosted via MS IIS on port 80. Jetty, an open-source web server that's often associated with dev ops or web application testing, is running on port 50000. nmap guesses that the box's operating system is Windows Server 2008 (this was incorrect, but it was a decent enough guess).<br /><br />I performed additional enumeration of the box's SMB services using <strong>enum4linux</strong> and nmap's collection of nifty SMB scripts. I also performed a brief UDP scan with nmap. I did not discover any additional information using these methods.<br /><br />IIS 10.0 and Jetty 9.4 are modern web servers and I did not consider it likely that there was a public exploit targeting a serious remote vulnerability in either. Some research on that front seemed to prove me correct. <br /><br />At this point, it was beginning to seem as though direct compromise of these services through a web server exploit or similar means was unlikely. Instead, I continued the enumeration process, shifting my attention to looking through the web content hosted on ports 80 and 50000 of the box.<br /><br /><br /><h1>Jeeves</h1><br />Navigating to the website hosted on port 80 of the box with a browser produced this page:<br /><br /><img src="images\3-2.png" alt="images\3-2.png" /><br /><br />This webpage appeared unfinished in many ways. None of the hyperlinks listed above the search bar lead to a valid URL, and searching for anything resulted in an image of an error message:<br /><br /><img src="images\3-3.png" alt="images\3-3.png" /><br /><br /><img src="images\3-4.png" alt="images\3-4.png" /><br /><br />I took note of this information, but again, this was an <strong>image</strong> of an old error message (see the page's HTML above) and not an actual error message generated by me poking around.<br /><br />While browsing this site to get a feel for it, I was also running <strong>Nikto</strong> and <strong>DirBuster</strong> against it in the background. This did not produce any significant information.<br /><br />Unsure what to make of all this, I decided I'd perform some quick enumeration of the web application being hosted on the Jetty server before digging too deeply into the Ask Jeeves page.<br /><br /><br /><h1>Jetty, Jenkins</h1><br />I followed the same enumeration procedure for the content hosted on the Jetty server as I did above, browsing its content manually to see what my eyes could find while Nikto and DirBuster slowly searched for hidden web content in the background. Locating any files or directories manually proved all but impossible, as the site did not have an index or any other discernible pages:<br /><br /><img src="images\3-5.png" alt="images\3-5.png" /><br /><br />For this reason, I eventually opted to wait until my automated scans were done before proceeding. Nikto did not discover anything too out of the ordinary, but DirBuster and its <strong>directories 1.0</strong> wordlist saved the day by discovering a directory named “askjeeves”:<br /><br /><img src="images\3-6.png" alt="images\3-6.png" /><br /><br />Browsing to the “askjeeves” directory, I found an unsecured <strong>Jenkins</strong> instance:<br /><br /><img src="images\3-7.png" alt="images\3-7.png" /><br /><br /><br />I am not intimately familiar with Jenkins, but once upon a time I was a software engineer and I am aware that it is a dev ops assistance application used to manage code versioning, testing and deployment. This set off alarm bells in my head that this could be a prime target for attack.<br /><br />In retrospect, I probably should have been able to intuit that there would be a directory named “askjeeves” here based on the information I discovered while enumerating the original web application. It's okay to be saved by automation once in a while, though. Onward to the initial breach.<br /><br /><br /><h1>Exploitation</h1><br />Knowing that Jenkins is a dev ops system, I suspected it might contain a way to upload arbitrary files and/or execute arbitrary code on the webserver, conditions which could enable a compromise. Little did I know it would be this easy; after following just two links (Manage Jenkins - - &gt; Script Console) I ended up here:<br /><br /><img src="images\3-8.png" alt="images\3-8.png" /><br /><br />The page speaks for itself. Yes, Jenkins contains an interface for executing arbitrary statements written in the Java-esque programming language <strong>Groovy</strong>. It'll even show you the results of the statements afterward. Like most programming languages, Groovy provides ways of interacting with the underlying operating system. I already knew the box was running Windows, so with a minute or two of Groovy syntax/API research I was executing system commands on the box:<br /><br /><img src="images\3-9.png" alt="images\3-9.png" /><br /><br />However, this isn't a very comfortable working environment. Post-exploitation is more easily performed with a reverse shell. Not wanting to write one from scratch in a language I don't know, I searched online and discovered an open-source Groovy shell at <a href="https://gist.github.com/frohoff/fed1ffaab9b9beeb1c76">https://gist.github.com/frohoff/fed1ffaab9b9beeb1c76</a>. Full credit to the original author. I changed the appropriate variables to allow me to catch the reverse shell connection with netcat on port 443. At that point, simply pasting the modified reverse shell code into the script field and pressing “run” gave me a reverse shell:<br /><br /><img src="images\3-10.png" alt="images\3-10.png" /><br /><br /><br /><h1>User Flag, Escalation</h1><br />With my shell running with the privileges of a user named “kohsuke” (who was not an administrator) I began to perform post-exploitation in earnest. It's necessary to gain administrative privileges on the machine to obtain the root flag. But first, I quickly snagged the user-mode flag by changing my working directory to C:\Users\kohsuke\Desktop and running <strong>type user.txt</strong>.<br /><br /><img src="images\3-11.png" alt="images\3-11.png" /><br /><br />After that, I performed a quick enumeration of the users, groups, and programs running on the box; these steps are not shown. I then began reading through each user's documents looking for something that I could leverage. At <strong>C:\Users\kohsuke\Documents</strong>, I found an interesting file:<br /><br /><img src="images\3-12.png" alt="images\3-12.png" /><br /><br />Googling the <strong>kdbx</strong> extension, I discovered that it represents an encrypted data store for a password manager program named <strong>KeePass</strong>. Figuring that the passwords inside could further my compromise of the box, I downloaded the file and researched the file type more deeply. I learned that the <strong>keepass2john</strong> utility could extract a password hash from this file that would then be loadable by the hash cracking utility <strong>John The Ripper</strong>. The process of using keepass2john and John itself to obtain the master password for the KeePass file is shown below. I chose to use a wordlist attack with the well-known <strong>rockyou</strong> wordlist.<br /><br /><img src="images\3-13.png" alt="images\3-13.png" /><br /><br />As indicated by the image, the password for the KeePass file was “moonshine1". To open the CEH.kdbx data store with this password, I downloaded the portable version of KeePass, executed it, and simply used the FIle → Open File menu option to load CEH.kdbx. When prompted, I provided the password that John found, which proved sufficient to decrypt the data store and show me many things I wasn't supposed to see:<br /><br /><img src="images\3-14.png" alt="images\3-14.png" /><br /><br />I examined each password individually and discovered that the “Backup stuff” password was an NTLM hash <strong>aad3b435b51404eeaad3b435b51404ee:e0fb1fb85756c24235ff238cbe81fe00. </strong>I thought that I could use this in a pass-the-hash attack against the JEEVES machine's Administrator account to gain elevated privileges. There are numerous tools that could aid us in doing this. I chose to use the simple <strong>pth-winexe</strong> program, shown below. Metasploit's <strong>exploit/windows/smb/psexec</strong> module is also an option.<br /><br /><img src="images\3-15.png" alt="images\3-15.png" /><br /><br />Bingo. With administrative privileges, the challenge was all but complete. All that was left at this point was to dump the root flag. Per HackTheBox's rules, the root flag should always be in a text file in the administrator's Desktop folder. However...<br /><br /><img src="images\3-16.png" alt="images\3-16.png" /><br /><br />Interesting. It appeared that the challenge's author was attempting to throw one last curveball at me. I knew that the challenge was unlikely to deviate from HackTheBox's rules and the flag was probably hiding in plain sight on the desktop. I read numerous malware analyses in the past which discussed attackers using an element of NTFS files called <strong>Alternate Data Streams</strong> (ADS) to hide information from analysis tools that are not aware of this little-known feature. I thought the real flag might be in an ADS of one of the files on the desktop. You can show alternate data streams in a directory listing with the <strong>/r</strong> switch:<br /><br /><img src="images\3-17.png" alt="images\3-17.png" /><br /><br />See that? “hm.txt” had an ADS called “root.txt”. Now that I knew it was there, the only trick left was knowing how to list it. Some Windows utilities recognize ADS and some don't. For example, <strong>type</strong>, the go-to utility for reading text from a file, does not, so I used the <strong>more</strong> command, which seemed okay with the following:<br /><br /><img src="images\3-18.png" alt="images\3-18.png" /><br /><br />That's it! The challenge is now completed. <br /><br /><br /><h1>Lessons Learned</h1><br />There is a limit to the degree with which challenges such as this can emulate reality, and many of them are not intended to emulate reality in the first place. Yet I am always thinking that games are not merely games. From the beginning of our lives, they shape the way we think, color the way we act, help us understand patterns and predict outcomes, are our first exposure to strategy, and generally help us comprehend everything that surrounds us. Perhaps the relationship isn't as direct as that of lions teaching their cubs a swipe of the claws, but it's there nonetheless. So, in that spirit, here are some echos of this challenge that I think are perfectly applicable to real-world hacking scenarios and may be valuable lessons for aspiring infosec folks like myself.<br /><br /><h3>Content is often web-facing by accident</h3><br />When someone is deploying numerous websites, using numerous technologies, and possibly isn't familiar with some of the tools they're using or the implications of their actions, it's quite easy for files and folders that were intended to remain private to be accidentally served to the internet. They can even be indexed by search engines. These files and folders may be backups of source code, text files, documents, database files, entire toolkits like Jenkins...nearly anything. The site operator and casual users may not notice these files or understand the risk they present, but determined bad guys will use open-source intelligence or forced browsing techniques (like the DirBuster attack used in this challenge) to locate them and take advantage of them. <br /><br />This type of vulnerability seems surprisingly common. Case in point: using Google trickery I crafted a targeted search to find web-facing Jenkins installs. There were hundreds. At a glance, several appeared to expose exactly the same “Manage Jenkins” interface--and therefore the same script console--as the box in the challenge. Luckily I'm not the bad guys, but you can bet the bad guys use this same technique and have probably already compromised those systems. Some of those systems may be honeypots, but I'd wager many are real systems.<br /><br /><img src="images\3-19.png" alt="images\3-19.png" /><br /><br /><h3>Forced browsing is wordlist-dependent</h3><br />Most forced browsing programs use a list of file/folder names and simply make a request for a resource with that name to the site in question. Based on the web server's reply, the tool and its operator determine whether a resource with that name exists on the site. This means that if you don't use the right list of words, you might fail to discover content that is waiting to be exploited by someone.<br /><br />For example, in this challenge I used the DirBuster program and selected a very large wordlist. If I had used another popular forced browsing program named <strong>dirb</strong> and its smaller default wordlist, it would not have discovered the "askjeeves" Jenkins directory because "askjeeves" is not in dirb's default wordlist. I would not have completed the challenge until I thought to try a different wordlist or intuited the presence of the directory through other means. <br /><br /><h3>Poor password practices often enable a breach</h3><br />There is a constant battle between what is convenient and what is secure, and passwords tend to be one of its first and most obvious casualties. This could include everything from unchanged default passwords to easily guessable passwords to reused passwords to passwords scribbled on sticky notes and stuck to an employee's workstation. In this case, it was a digital version of the latter.<br /><br />Keeping passwords in files, whether in plaintext, encrypted, or hashed, is awfully convenient, but it's also an outright poor idea from a defensive perspective. These are among the first things that attackers should look for when they've gained partial access to a system and are seeking to elevate to complete control. Browse desktops, documents/home folders, the install directories of programs, and so on looking for files that may contain passwords. Automate the search with a command-line utility if it will help. Attackers often refer to finds such as the KeePass file in the challenge as "quick wins," which isn't what you want to hear a hacker say.<br /><br /><h3>Tools that manage become tools that attack</h3><br />It doesn't take a lot of imagination to turn something that's designed for managing a system into a tool for enumerating and compromising that same system--see numerous abuses of <strong>Powershell</strong>, <strong>WMIC</strong>, <strong>cron</strong>, <strong>sudo</strong>, and so on. Jenkins is obviously a powerful platform for administrating web/development servers, which means that unless it's expressly configured to prevent this sort of mischief, it can easily bite the hand that feeds it. The same goes for too many other programs to name.<br /><br />I knew as soon as I saw the “Manage Jenkins” menu option that I had struck gold, and that's only scratching the surface of what you might learn from a real-world Jenkins installation. You the attacker should have a similar intuition about what programs can be leveraged for your purposes. You the defender should have a desire to configure these programs as appropriately as possible to prevent abuse.<br /><br /><br /><h1>Conclusion, Additional Resources</h1><br />This challenge was a lot of fun. I thank its creator for providing this learning experience, HackTheBox for hosting their virtual labs, and anyone who made it this far for reading. Below are supplementary resources for some of the topics discussed here.<br /><br />Nmap port scanning, service detection, OS detection:<br /><a href="https://nmap.org/book/man-port-scanning-techniques.html">https://nmap.org/book/man-port-scanning-techniques.html</a><br /><a href="https://nmap.org/book/man-version-detection.html">https://nmap.org/book/man-version-detection.html</a><br /><a href="https://nmap.org/book/man-os-detection.html">https://nmap.org/book/man-os-detection.html</a><br /><br />Forced browsing, DirBuster:<br /><a href="https://www.owasp.org/index.php/Forced_browsing">https://www.owasp.org/index.php/Forced_browsing</a><br /><a href="https://www.owasp.org/images/1/19/OTGv4.pdf">https://www.owasp.org/images/1/19/OTGv4.pdf</a> (Large file; discussion of forced browsing begins on page ~53)<br /><a href="https://www.owasp.org/index.php/Category:OWASP_DirBuster_Project">https://www.owasp.org/index.php/Category:OWASP_DirBuster_Project</a><br /><br />Jenkins:<br /><a href="https://jenkins.io/doc/">https://jenkins.io/doc/</a> (Jenkins statement of purpose, documentation base)<br /><a href="https://jenkins.io/doc/book/managing/">https://jenkins.io/doc/book/managing/</a> (Section specific to the "Manage Jenkins" interface)<br /><br />Practical attacks against KeePass:<br /><a href="http://www.harmj0y.net/blog/redteaming/a-case-study-in-attacking-keepass/">http://www.harmj0y.net/blog/redteaming/a-case-study-in-attacking-keepass/</a><br /><br />Pass-the-Hash attacks:<br /><a href="https://blog.ropnop.com/practical-usage-of-ntlm-hashes/">https://blog.ropnop.com/practical-usage-of-ntlm-hashes/</a><br /><a href="https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/">https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/</a><br /><br />Alternate data streams:<br /><a href="https://hshrzd.wordpress.com/2016/03/19/introduction-to-ads-alternate-data-streams/">https://hshrzd.wordpress.com/2016/03/19/introduction-to-ads-alternate-data-streams/</a><br /><a href="https://blogs.technet.microsoft.com/askcore/2013/03/24/alternate-data-streams-in-ntfs/">https://blogs.technet.microsoft.com/askcore/2013/03/24/alternate-data-streams-in-ntfs/</a><br /></div></div>
</body></html>