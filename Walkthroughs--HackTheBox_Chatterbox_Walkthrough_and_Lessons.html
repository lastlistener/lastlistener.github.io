<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>HackTheBox: Chatterbox Walkthrough and Lessons</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="styles.css" type="text/css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-120451103-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-120451103-1');
</script>


</head>
<body><div class="main"><div class="tree">
<p><strong>Index</strong></p>
<p><a href="About.html">About</a></p>

<p><a href="Walkthroughs.html">Walkthroughs</a></p>

<ol>
<li><a href="Walkthroughs--HackTheBox_Jeeves_Walkthrough_and_Lessons.html">HackTheBox: Jeeves Walkthrough and Lessons</a></li>
<li><a href="Walkthroughs--HackTheBox_Bashed_Walkthrough_and_Lessons.html">HackTheBox: Bashed Walkthrough and Lessons</a></li>
<li><a href="Walkthroughs--HackTheBox_Chatterbox_Walkthrough_and_Lessons.html">HackTheBox: Chatterbox Walkthrough and Lessons</a></li>
</ol>
<p><a href="Courses.html">Courses</a></p>

<ol>
<li><a href="Courses--SLAE.html">SLAE</a></li>
<ol>
<li><a href="Courses--SLAE--1_TCP_Bind_Shellcode.html">1: TCP Bind Shellcode</a></li>
<li><a href="Courses--SLAE--2_TCP_Reverse_Shell.html">2: TCP Reverse Shell</a></li>
<li><a href="Courses--SLAE--3_Egghunter_Shellcode.html">3: Egghunter Shellcode</a></li>
<li><a href="Courses--SLAE--4_Shellcode_Encoding_Scheme.html">4: Shellcode Encoding Scheme</a></li>
<li><a href="Courses--SLAE--5.1_Metasploit_TCP_Bind_Shellcode_Analysis.html">5.1: Metasploit TCP Bind Shellcode Analysis</a></li>
<li><a href="Courses--SLAE--5.2_Metasploit_chmod_Shellcode_Analysis.html">5.2: Metasploit chmod Shellcode Analysis</a></li>
<li><a href="Courses--SLAE--5.3_Metasploit_exec_Shellcode_Analysis.html">5.3: Metasploit exec Shellcode Analysis</a></li>
<li><a href="Courses--SLAE--6_Polymorphic_Shellcode.html">6: Polymorphic Shellcode</a></li>
<li><a href="Courses--SLAE--7_Shellcode_Crypter.html">7: Shellcode Crypter</a></li>
</ol></ol></div>
<div class="page"><h1><b><u>HackTheBox: Chatterbox Walkthrough and Lessons</u></b></h1>Chatterbox is a vulnerable machine found on the infosec puzzle platform <a href="http://HackTheBox.eu">HackTheBox.eu</a>. It is a Windows hacking challenge that the site's users have classified as beginner-to-intermediate (4/10)  in difficulty level. A few possible issues with reconnaissance aside, I believe it's a fairly easy machine to hack. Yet we all start as beginners (I still consider myself one) and we all have gaps in our knowledge to be filled and faulty assumptions we sometimes must shed, so I can see how a machine such as this could be tricky for some infosec initiates. Below I will describe a process for hacking this box and conclude with a description of some practical security lessons that can be learned from it.<br /><br /><h1>Discovering the Chatter</h1><br />I began with an <strong>nmap</strong> scan of common TCP ports:<br /><br /><img src="images\5-1.png" alt="images\5-1.png" /><br /><br />Huh. This machine didn't seem like a "chatterbox" so far. No listening ports were definitively detected by the scan. That usually means that either the machine is behind some sort of network obstacle (such as a firewall) that's interfering with the scan, or the machine's services are listening on irregular ports that nmap won't scan by default.<br /><br />I conducted a more comprehensive (though hasty) TCP connect port scan and discovered services on ports 9255 and 9256:<br /><br /><img src="images\5-2.png" alt="images\5-2.png" /><br /><br />Okay, now I had a little something to go on. I hit the discovered services with a version scan to obtain more information:<br /><br /><img src="images\5-3.png" alt="images\5-3.png" /><br /><br />A little bit of research told me that <a href="https://sourceforge.net/projects/achat/">Achat</a> is a freeware solution for conducting instant messaging and file sharing across a LAN. A little bit more research told me that some versions of it are vulnerable to a remote buffer overflow attack:<br /><br /><img src="images\5-4.png" alt="images\5-4.png" /><br /><br />I decided to use the public exploit in the above image, which can be found either in your install of Kali at the path described in the screenshot or at <a href="https://www.exploit-db.com/exploits/36025/">this url</a>. With this exploit, I quickly compromised the box.<br /><br /><h1>Exploit Modification, Exploitation, User Flag</h1><br />Reading the exploit code, it seemed like a fairly simple Python script that constructs a buffer of a couple hundred thousand bytes. The buffer consists of boilerplate to appease the application, junk bytes to overflow the application's buffer, and finally the shellcode that will be executed when the exploitation process is complete. The script then sends the buffer to a hard-coded IP address and port a few thousand bytes at a time in UDP packets.<br /><br />Two salient points jumped out at me while reading the exploit:<br /><br /><img src="images\5-5.png" alt="images\5-5.png" /><br /><br />First of all, the exploit as written is a proof of concept in the truest sense: its payload is not weaponized at all and does nothing but open <strong>Windows Calculator</strong> on the target machine. This is a common test that exploit writers use because it provides easy visual proof of exploitation and demonstrates the potential impact of the exploit (running a program on a remote system) while also being non-invasive relative to a shell or other payload. However, if we want to use this script to actually compromise a system, we need to generate our own shellcode payload and use it instead of the calc shellcode. We can do that with the Metasploit Project's <strong>msfvenom</strong> program.<br /><br />The exploit author was nice enough to show the full msfvenom command used to generate the calc.exe shellcode, including bad characters. Appropriate shellcode for exploitation could therefore be generated by running the same command but with a reverse shell payload specified:<br /><br /><img src="images\5-6.png" alt="images\5-6.png" /><br /><br /><strong>LHOST</strong> was my attacking machine's IP address. Once this shellcode was generated, I edited the exploit proof of concept and replaced the entire <strong>"buf"</strong> variable shown in the previous image with the generated shellcode.<br /><br />The second salient point from reading the exploit script was that the IP and port that the exploit will target were hard-coded:<br /><br /><img src="images\5-7.png" alt="images\5-7.png" /><br /><br />The port is fine, but obviously the exploit wouldn't work against Chatterbox until I replaced the IP address with Chatterbox's IP, <strong>10.10.10.74</strong>. I did so, then set up a <strong>netcat</strong> listener to catch the reverse shell connection and fired away<strong>*</strong>:<br /><br /><img src="images\5-8.png" alt="images\5-8.png" /><br /><img src="images\5-9.png" alt="images\5-9.png" /><br /><br />I had hacked the machine and become <strong>chatterbox\alfred</strong>. Grabbing the flag that signifies I've breached a user account:<br /><br /><img src="images\5-10.png" alt="images\5-10.png" /><br /><br />Next up: post-exploitation.<br /><br /><strong>*</strong>In testing this exploit since then, I have noticed that the exploit is finicky and sometimes must be run two or three times before successfully executing the shellcode. This may have been another cause of frustration among HackTheBox participants. Reading <a href="https://www.rapid7.com/db/modules/exploit/windows/misc/achat_bof">Rapid7's</a> description of the exploit, it seems like this may have been because the exploit deals with timing issues/race conditions.<br /><br /><h1>Post-Exploitation, Root Flag</h1><br />On HackTheBox, the "root" flag is always on the <strong>Desktop</strong> of the Administrator account:<br /><br /><img src="images\5-11.png" alt="images\5-11.png" /><br /><br />I could <strong>cd</strong> to the directory and see the flag file, but I could not list its contents. Examining the file with the <strong>icacls</strong> permission utility, I could see why:<br /><br /><img src="images\5-12.png" alt="images\5-12.png" /><br /><br />The Administrator account had full access to the file and my Alfred account had none. However, once I obtained a little more information about the file, it was easy to change that. The <strong>dir</strong> command's <strong>/q</strong> switch will show ownership information ("q" for "ownership"...makes sense, no?) about every file and directory in the output listing. In this case, it showed that my compromised user account Alfred actually owned the <strong>root.txt</strong> flag file:<br /><br /><img src="images\5-13.png" alt="images\5-13.png" /><br /><br />In Windows, if you are the owner of a file, <a href="https://technet.microsoft.com/en-us/library/ff404240.aspx">you have the ability to grant users access to it regardless of anything else</a>. So while my account had apparently been stripped of permission to read or edit the file, my ownership of it gave me the ability to grant those permissions to anyone, myself included. I used <strong>icacls</strong> with the <strong>/grant</strong> switch to give my account full access to the file:<br /><br /><img src="images\5-14.png" alt="images\5-14.png" /><br /><br />Thus ends the walkthrough; at this point I had obtained both the user flag and the root flag and fulfilled the challenge requirements.<br /><br /><h1>Lessons Learned</h1><br />After I've solved a vulnerable machine, I often search the internet to see what other participants found difficult about it. I was surprised to find a huge number of people who struggled mightily with this machine. It seemed that the enumeration process in particular frustrated many. Yet we cannot blame the machine simply for presenting us with a challenge, and must instead learn more and adapt our ways of thinking to meet any challenge. It is our own misgivings and gaps in knowledge that can turn an exercise such as this from trivial to excruciating. Here are some lessons from this machine that could help avoid that excruciation in the future and in the real world.<br /><br /><h3>Learn How Your Tools Work</h3><br />Something I learned from reading of issues people had with this challenge: many did not seem to know how <strong>nmap</strong> works, how to adapt it to their needs, or how to recognize a situation wherein their needs diverted from the norm. They were unable to effectively cope when the default nmap port settings weren't suited to this challenge. This is significant. Nmap is among the most flexible and essential tools in a hacker's kit.<br /><br />When executed without port settings specified, nmap scans ports based on a popularity contest. It has an internal database of ports ranked by how common they are. When you perform this scan...<br /><br /><code>nmap -sSV 127.0.0.1</code><br /><br />...you have not specified any port-related parameters, so nmap will use its default port settings, which are to scan the 1000 most common ports for the underlying transport protocol of your scan. A SYN scan is a TCP scan, so this command will scan the 1000 TCP ports that are statistically the most common--ports like 80, 443, 445, 139, 21, and so on. <a href="https://www.youtube.com/watch?v=Hk-21p2m8YY">A talk by the creator of nmap</a> gives a window into how the data regarding port use frequency was initially obtained.<br /><br />Port scanning is a balancing act in which you must weigh how comprehensive the scan is against how much the scan "costs." That is, how long the scan will take, how much bandwidth the scan is using, how intrusive the scan is, the environment in which you are conducting the scan, and a variety of other factors. Nmap's default settings are meant to represent an ideal reward:cost ratio. Using these settings bears a high probability that you will discover some open ports for your efforts, but you must also understand that such a scan is not comprehensive and comes bundled with at least a slight chance that you could be missing something critical like the AChat service. When you get the feeling that you need to widen your scanning berth, you need to be familiar enough with nmap's port and timing options to cook up different scans on the fly.<br /><br />I cannot teach you everything there is to know about nmap, but I will tell you what served me well and what I would recommend you do. Go to <a href="https://nmap.org/book/man.html">this</a> page. Read everything there from beginning to end. Take notes. Then do that again. The second time, try each newly described scan parameter against a VM image with some services exposed. Then try combining it with others.  Once in a while, come back and study your notes and the linked page. Do whatever you need to do to remember the bulk of nmap's settings, know what each does, and be able to concoct a scan at any given moment. In addition to studying this page, taking notes, and regularly using nmap, I made a deck of flash cards about nmap and studied them for a few minutes each day.<br /><br />These might not sound like the most exciting exercises in the world, but I cannot describe how much time and frustration all of the above saved me in the long run and how much it amplified the usefulness of nmap to me.<br /><br />nmap is only one tool, and this lesson holds true for all tools: know how they work or their usefulness is severely limited. Most security tools have a default setting that will be of some use, but it's knowing the other parameters and how the tool functions internally that allows you to bend the tool to your will. For every tool that you use, you should:<br /><br />• Be able to describe at a high level how that tool functions and what it is doing/automating<br />• Fluently understand each of its options and when/how to use them<br /><br /><h3>Read and Understand Public Exploit Code Before Use</h3><br />This definitely falls under the header of "learn how your tools work," but public exploits are a special case for several reasons:<br /><br />• They tend to be one-off scripts written by anonymous individuals and sourced from various places.<br />• They may require modification to suit your needs.<br />• They often contain encoded code or code the purpose of which is not immediately obvious.<br /><br />A few reasons you should always review exploit code before running it:<br /><br />• The exploit code may be fake or harmful, and you want to determine this before running it rather than after.<br />• You want to know how the exploit code works, what payload it delivers, whether you need to change that payload, and what will constitute a successful exploitation. Knowing this information up front could save you loads of wasted time speculating about why the exploit doesn't work the way you want it to later.<br />• The exploit author's description of how to use/modify the exploit or common pitfalls encountered during exploitation may be embedded within the exploit code itself as comments.<br /><br />Recall that the exploit used in this challenge was originally a proof of concept that did nothing but launch the Windows "calc.exe" application when the exploit was successful. Well, sure enough, when I ran the <strong>tasklist</strong> command on the compromised Chatterbox, I found some lingering calculators...<br /><br /><img src="images\5-15.png" alt="images\5-15.png" /><br /><br />This means that other people attempting the challenge--ostensibly people people studying information security--were running the same exploit that I had discovered against the target without reading the actual exploitation code and having modified only the IP/port values in the script. This course of action is a waste of time at best and dangerous at worst. To avoid such a mistake, read the exploit code up front and understand what it expects from you and what you should expect from it.<br /><br /><h3>A Non-Administrative Breach Can Spell Trouble</h3><br />You'll notice something about this challenge: I never elevated my privileges to the administrative level, yet I still manipulated sensitive information that I was not supposed to have access to.<br /><br />Modern penetration testing and security education seems heavy on privilege escalation and post-exploitation strategies. This is a good thing. Real attackers clearly love tightening and persisting their control of a network and pivoting deeper into an organization after they've made their initial intrusion. It's often how they find sensitive data and strike at that organization's heart. So it behooves us to study privilege escalation and pivoting in a general sense.<br /><br />Yet here is a good lesson: attackers sometimes don't need to hack a domain controller or even be a local administrator to steal information or cause damage. Intruders tend to "live off the land" in numerous ways. They do whatever they can with what they have access to. If they have access to Alfred in Operations's account and he controls all of your Operations Department's information, well, the intruders control all of your Operations Department's information regardless of whether they have pivoted adequately, own your whole network, have domain admin privileges, etc. This is why defenders and attackers must analyze the organization in question and consider <strong>all</strong> ways attackers could conceivably harm it (a process called <strong>threat modeling</strong>) rather than simply recycling generic goals like "let's get domain admin."<br /><br /><h1>Conclusion</h1><br />I actually liked this machine a lot. It presents the opportunity to learn several good lessons about reconnaissance, exploitation and file permissions. It was also nice to see a challenge with more traditional network exploitation techniques, as HackTheBox machines seem heavily tilted toward web exploitation in general. I can see how it might have frustrated some, but from frustration much knowledge and motivation to be better can be obtained. A huge thank you to <a href="http://HackTheBox.eu">HackTheBox.eu</a> for hosting the vulnerable machine, the machine's creator for spending time to create a fun little puzzle, and the astute reader for making it through this walkthrough.</div></div>
</body></html>